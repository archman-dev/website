# Category structure: build-or-validate (v1)

Purpose

- Transform a single Markdown doc into a nested Docusaurus category. Assume the topic is deep whenever this prompt is invoked. Always create a nested structure from headers and subheaders. Works recursively at any depth under `docs/`.
- Enforce the canonical source of truth `.github/instructions/canonical/docs-structure.v1.0.0.md` ("canonical"). Canonical strictly governs naming, ordering, and presence of sections. `./docs` must conform to canonical; canonical is never modified by this process.

Inputs

- targetPath: absolute or repo-relative path under `docs/`. May be a Markdown file (e.g., `docs/foundations/principles.md`) or a folder (e.g., `docs/foundations/principles`).
- mode: `build` (default) or `validate`.
- canonicalPath: path to the canonical structure file. Default: `.github/instructions/canonical/docs-structure.v1.0.0.md`.

Outputs

- build: conforms the target subtree to canonical. Creates/renames folders and files to match canonical, adds `index.mdx` in parent folders with overview and cards, generates leaf `.md` files, rewrites intra-doc links. No changes are ever made to the canonical file.
- validate: returns a PASS or FAIL report with precise diffs for bringing `./docs` into compliance with canonical. Extras not present in canonical are reported as violations; no writes.

Repo assumptions

- Docusaurus v3 with autogenerated sidebar (`sidebars.ts` uses `{ type: 'autogenerated', dirName: '.' }`).
- Category pages should show standard doc cards. We implement this with `index.mdx` that renders the category card list, not a generated-index link, to allow a custom overview paragraph.
- Index page slug hygiene: Do NOT set frontmatter `slug` on any `index.mdx` or `index.md`. The effective route must equal the folder path to avoid duplicate trailing segments.

Splitting policy (deterministic)

- Always convert the target file into a category folder with `index.mdx` and `_category_.json`.
- Use canonical to drive structure. The canonical tree is final:
  - Every canonical non-leaf node is a folder with `_category_.json` and `index.mdx`.
  - Every canonical leaf node is a `.md` file (not `.mdx`).
  - Preserve canonical order exactly; do not sort.
- Do not inline leaf content in parents. Parent `index.mdx` contains only overview text and a DocCardList.

Build steps (idempotent and safe)

## Step 0. Preconditions

- targetPath must exist under `docs/`.
- If targetPath is a folder: choose the primary doc in this order if present: `index.mdx`, `index.md`, `overview.md`. If none found, return VALIDATE FAIL asking to specify a file path.
- If targetPath is a file: it must end with `.md` or `.mdx`.
- If a sibling folder with the same stem already exists (for example, `principles/` for `principles.md`), switch to Validate (do not duplicate).

## Step 0.1. Load canonical structure

- Require `canonicalPath` to exist. Parse it into a normalized tree of categories and leaves with:
  - id: normalized slug (see slugify rules below)
  - label: display title
  - children: ordered array of nodes (categories first where relevant, order preserved as authored)
- If canonical is missing or malformed, return VALIDATE FAIL with guidance and do not mutate `./docs`.

## Step 1. Plan the structure

- folderName = stem of target file (for example, `principles`).
- folderPath = dirname(targetPath) + `/` + folderName.
- parentLabel = canonical node label for the target subtree; if canonical context is ambiguous, fallback to the doc title (first `# Heading`) or filename.
- childSubtopics = canonical children of the target node (ignore source headings for structural decisions).
- slugify: lowercase, hyphenated, remove non-alphanumerics, collapse dashes, max 60 chars. If the slug exceeds 60 chars, truncate to 60. If a filename collision occurs, append a short suffix (`-2`, `-3`, …) or a 6-char hash to ensure uniqueness. When deriving slugs from canonical labels, ignore any leading numeric enumeration (e.g., `"1.", "1.2.3", "1.2.3.4" etc`).

## Step 1.1. Canonical mapping and reconciliation plan

- Map the planned structure to canonical using normalized comparison:
  - Normalize both sides using the same slugify routine for ids.
  - A node matches when either label case-insensitive equals, or slug equals. Prefer canonical label and slug if both present with a mismatch.
  - Preserve canonical order of siblings; local order is ignored.
- Produce three sets per level:
  - toRename: docs nodes whose label/slug differ from canonical; plan renames to canonical label and slug.
  - toCreate: canonical nodes missing in docs; plan to scaffold files/folders and stub content.
  - toRemove: docs nodes not present in canonical; report as violations (must be removed or relocated outside the canonical tree).

## Step 2. Create or upgrade the category folder

- Move the original file content into `folderPath/index.mdx`.
- Create or merge `_category_.json` in `folderPath`:

```json
{
 "label": "PARENT_LABEL",
 "position": 1,
 "collapsed": false
}
```

- Do not set `link.generated-index` if `index.mdx` exists (we render cards manually).

## Step 2.1. Apply canonical renames (safe)

- For each entry in `toRename`:
  - Rename folders/files to canonical slugs (respect 60-char limit; if collision, append `-2`, `-3`, … or 6-char hash).
  - Update `_category_.json` label to canonical label.
  - Update headings in `index.mdx` and leaf `.md/.mdx` to canonical labels at the corresponding levels.
  - Rewrite relative links to the new paths.

## Step 3. Author index.mdx with overview and cards

- Preserve any frontmatter at top; convert to MDX if needed. Remove any `slug` from index frontmatter to rely on folder path.
- Keep the introductory paragraphs above the first `##` section as the overview, trimmed to 180 words or less. If no intro, synthesize a 1–2 sentence overview from title and section names.
- Append a DocCard list to render standard cards:

```mdx
---
import DocCardList from '@theme/DocCardList'
import {useCurrentSidebarCategory} from '@docusaurus/theme-common'

# PARENT_LABEL

OVERVIEW_PARAGRAPHS

<DocCardList items={useCurrentSidebarCategory().items} />
```

- Do not inline child content in parent `index.mdx`. Keep overview under ~180 words followed by the DocCardList.

- Add a vertical “Learning map” figure (Mermaid `flowchart TB` or `mindmap`) wrapped in `<Figure>` to show recommended navigation through subtopics.
- Add a short "Prerequisites" list (bullets) with relative links to required prior topics within the docs tree (when applicable).
- When including any diagram or image, always wrap in the `Figure` component per widget guidance.
- Add SEO meta and structured data at the category level:
  - Frontmatter: `title`, `description` (≤160), `keywords` (8–20), `image` (1200×630).
  - Insert `<Head>` with `Article` JSON‑LD (category overview) and a `BreadcrumbList` JSON‑LD reflecting the category path.

## Step 3.1. Scaffold missing canonical items

- For each entry in `toCreate`:
  - Create the folder or file path dictated by canonical, using canonical slug/label.
  - Author minimal, valid stubs to keep builds green:
    - Category folder: `_category_.json` with canonical label, `index.mdx` with a title and a short overview plus `<DocCardList />`.
    - Leaf file: `LEAF_SLUG.md` with a H1 title (canonical label) and a short TBD paragraph.
  - In the parent `index.mdx`, include only a brief summary sentence introducing the child group; content lives in leaves.

## Step 4. Split sections into child docs and folders

- Use canonical to drive splitting, not source heading sizes. For each canonical node:
  - If leaf: create/update `.../LEAF_SLUG.md` and move corresponding content from the source into that file.
  - If parent: create/update `.../PARENT_SLUG/index.mdx` with overview (intro text before first subheading) and a DocCardList. Do not include full child content here.
- Replace in the parent `index.mdx` the original section text with a short 1–2 sentence summary and a relative link to the child path `./CHILD_SLUG`.
- Apply the same pattern recursively for all depths.

## Step 4.1. Canonical ordering enforcement

- Within each `index.mdx`, order cards and links according to canonical sibling order. Extras not in canonical are not shown and must be removed to pass validation.

## Step 5. Assets and links

- If a section references images in the parent folder, copy those images into `folderPath/` (or keep paths valid) and update relative links accordingly.
- Convert intra-document anchors that pointed to `#subtopic` into file links `./SLUG`.
- Do not change absolute `/img/...` references.

## Step 5.1. Redirects and legacy anchors

- When renaming slugs, update local anchors to file links and insert a brief note in commit/report containing a mapping table. If the project uses Docusaurus client redirects, add a redirect frontmatter when available; otherwise, ensure no broken links remain.

## Step 6. Recursion support

- The same procedure applies if `targetPath` is deeper (for example, `docs/foundations/principles/SOME_PRINCIPLE.md`). Create `.../SOME_PRINCIPLE/index.mdx` and split further using the rules above.

Validation steps (no writes)

- Check existence and content:
  - `folderPath/_category_.json` exists with label equal to the canonical parent label.
  - `folderPath/index.mdx` contains the DocCardList import and usage and an overview under ~180 words.
  - `folderPath/index.mdx` includes a vertical “Learning map” figure and a "Prerequisites" list with at least one internal link (when applicable).
  - `folderPath/index.mdx` includes SEO meta (frontmatter `description`, `keywords`, `image`) and JSON‑LD scripts (`Article`, `BreadcrumbList`).
  - `folderPath/index.mdx` frontmatter does NOT set `slug` (route derives from the folder path). If present, this is a FAIL and must be removed.
  - For each canonical node under the target subtree, in order:
    - If parent: `.../PARENT_SLUG/index.mdx` exists with DocCardList and an overview; `_category_.json` label matches canonical.
    - If leaf: `.../LEAF_SLUG.md` exists with a single H1 matching the canonical label (additional content allowed).
  - No extra files/folders exist that are not present in canonical (or they are listed under toRemove in the validation report).
  - Links in `index.mdx` reference `./CHILD_SLUG` (or deeper `./PARENT_SLUG/LEAF_SLUG`); no leftover anchors to removed sections.
  - No duplicate slugs; filenames are kebab-case and <= 60 chars (or have safe suffixes/hashes if collisions were resolved).
  - No duplicate trailing segments in routes (e.g., `.../x/x`).
  - Build sanity: `pnpm build` would succeed (no broken links) given these changes.
- Report PASS or list concrete fixes per rule above, grouped as: toCreate, toRename, toRemove.

Edge cases

- If the source file already is `index.md` or `index.mdx` within a folder, treat that folder as the category and perform only split or validate.
- Even if the source has no subheadings, create the canonical parent folder and required leaf `.md` files as stubs to match canonical. Do not inline leaf content in parents.
- Preserve code fences and admonitions as-is; do not split inside an unfinished or malformed section.

Example

- Input: `docs/foundations/principles.md`.
- Output:
  - `docs/foundations/principles/_category_.json` (label: "Principles").
  - `docs/foundations/principles/index.mdx` (overview and DocCardList for H2 items).
  - For an H2 without H3: `docs/foundations/principles/loose-coupling.md`.
  - For an H2 with H3s: `docs/foundations/principles/consistency/` with:
    - `index.mdx` (overview and DocCardList for H3 items)
    - `trade-offs.md`
    - `patterns.md`

Success criteria

- Autogenerated sidebar surfaces the new category and child docs naturally (no manual sidebar edits required).
- Navigating to the category path shows overview text followed by standard cards for subfiles.
- Re-running in the same location is idempotent (no duplication, stable names, only minimal diffs when content changes).
- `./docs` conforms exactly to canonical for the affected subtree: labels, slugs, and ordering match; validation shows PASS with zero diffs after one reconcile pass.
